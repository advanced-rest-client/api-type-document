<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="api-type-document.html">
<link rel="import" href="property-range-document.html">
<link rel="import" href="property-document-mixin.html">
<dom-module id="property-shape-document">
  <template>
    <style include="markdown-styles"></style>
    <style>
    :host {
      display: block;
      padding: 20px 0;
      border-bottom: 1px var(--property-shape-document-border-bottom-color, #CFD8DC) dashed;
      @apply --property-shape-document;
    }

    :host(:last-of-type) {
      border-bottom: none;
    }

    [hidden] {
      display: none !important;
    }

    .property-title {
      @apply --arc-font-subhead;
      margin: 0 0 20px 0;
      font-size: 18px;
      @apply --property-shape-document-title;
    }

    .parent-label {
      color: var(--api-type-document-property-parent-color, #757575);
    }

    .property-name {
      font-weight: 400;
      color: var(--api-type-document-property-color, #757575);
    }

    .doc-wrapper {
      @apply --layout-horizontal;
      transition: background-color 0.4s linear;
    }

    .doc-border {
      width: 2px;
      background-color: transparent;
      cursor: pointer;
    }

    .doc-content {
      @apply --layout-flex;
      margin-left: var(--api-type-document-docs-margin-left, 0px);
    }

    :host([is-union]) > .doc-wrapper > .doc-content,
    :host([is-array]) > .doc-wrapper > .doc-content,
    :host([is-object]) > .doc-wrapper > .doc-content {
      margin-left: var(--api-type-document-child-docs-margin-left, 24px);
    }

    :host([is-union]) > .doc-wrapper,
    :host([is-array]) > .doc-wrapper,
    :host([is-object]) > .doc-wrapper {
      margin-top: 12px;
    }

    :host([is-union])  > .doc-wrapper > .doc-border {
      background-color: var(--property-shape-document-union-color, #FFEB3B);
    }

    :host([is-union][active]) > .doc-wrapper {
      background-color: var(--property-shape-document-union-color-active, rgba(255, 235, 59, 0.24));
    }

    :host([is-array]) > .doc-wrapper > .doc-border {
      background-color: var(--property-shape-document-array-color, #8BC34A);
    }

    :host([is-array][active]) > .doc-wrapper {
      background-color: var(--property-shape-document-array-color-active, rgba(139, 195, 74, 0.24));
    }

    :host([is-object]) > .doc-wrapper > .doc-border {
      background-color: var(--property-shape-document-object-color, #FF9800);
    }

    :host([is-object][active]) > .doc-wrapper {
      background-color: var(--property-shape-document-object-color-active, rgba(255, 152, 0, 0.24));
    }

    .property-traits {
      @apply --layout-horizontal;
      @apply --layout-wrap;
    }

    .property-traits > span {
      display: inline-block;
      margin-right: 8px;
      padding: 4px 8px;
      background-color: var(--api-type-document-trait-background-color, #EEEEEE);
      border-radius: 3px;
    }

    .property-traits > span.data-type {
      background-color: var(--api-type-document-type-background-color, #2196F3);
      color: white;
    }

    .property-description {
      margin: 20px 0;
    }
    </style>
    <template is="dom-if" if="[[displayName]]">
      <h4 class="property-title">
        <template is="dom-if" if="[[parentTypeName]]"><span class="parent-label">[[parentTypeName]].</span></template>
        <span class="property-name" hidden$="[[!hasDisplayName]]">[[propertyName]]</span>
        <span>[[displayName]]</span>
      </h4>
    </template>
    <div class="property-traits">
      <span class="data-type">[[propertyDataType]]</span>
      <template is="dom-if" if="[[isRequired]]">
        <span class="required-type" title="This property is required by the API">Required</span>
      </template>
      <template is="dom-if" if="[[isEnum]]">
        <span class="enym-type" title="This property represent enumerable value">Enum</span>
      </template>
    </div>
    <template is="dom-if" if="[[propertyDescription]]">
      <div class="property-description">
        <marked-element markdown="[[propertyDescription]]">
          <div slot="markdown-html" class="markdown-body"></div>
        </marked-element>
      </div>
    </template>
    <div class="doc-wrapper">
      <div class="doc-border" on-mouseover="_borderHover" on-mouseout="_borderBlur"></div>
      <div class="doc-content">
        <property-range-document amf-model="[[amfModel]]" shape="[[shape]]" range="[[range]]"></property-range-document>
        <template is="dom-if" if="[[isArray]]">
          <api-type-document class="children" amf-model="[[amfModel]]" type="[[range]]" parent-type-name="item"></api-type-document>
        </template>
        <template is="dom-if" if="[[isObject]]">
          <api-type-document class="children" amf-model="[[amfModel]]" type="[[range]]" parent-type-name="[[displayName]]"></api-type-document>
        </template>
        <template is="dom-if" if="[[isUnion]]">
          <api-type-document class="children" amf-model="[[amfModel]]" type="[[range]]" parent-type-name="[[displayName]]"></api-type-document>
        </template>
      </div>
    </div>
  </template>
  <script>
  /**
   * `property-shape-document`
   *
   * Renders a documentation for a shape property of AMF model.
   *
   * ## Styling
   *
   * `<property-shape-document>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--property-shape-document` | Mixin applied to this elment | `{}`
   * `--property-shape-document-array-color` | Property border color when type is an array | `#8BC34A`
   * `--property-shape-document-object-color` | Property border color when type is an object | `#FF9800`
   * `--property-shape-document-union-color` | Property border color when type is an union | `#FFEB3B`
   * `--arc-font-subhead` | Theme mixin, applied to the property title | `{}`
   * `--property-shape-document-title` | Mixin applied to the property title | `{}`
   * `--api-type-document-property-parent-color` | Color of the parent property label | `#757575`
   * `--api-type-document-property-color` | Color of the property name label when display name is used | `#757575`
   * `--api-type-document-docs-margin-left` | Margin left of the item's properties description relative to the title. | `12px`
   * `--api-type-document-child-docs-margin-left` | Margin left of the item's properties description relative to the title when the item is a child property of another property | `24px`
   * `--api-type-document-type-background-color` | Background color of the "type" trait | `#2196F3`
   * `--api-type-document-trait-background-color` | Background color to main range trait (type, required, enum) | `#EEEEEE`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   * @appliesMixin ArcBehaviors.PropertyDocumentMixin
   */
  class PropertyShapeDocument extends ArcBehaviors.PropertyDocumentMixin(Polymer.Element) {
    static get is() { return 'property-shape-document'; }
    static get properties() {
      return {
        /**
         * Computed value of shape's http://raml.org/vocabularies/shapes#range
         * @type {Object}
         */
        range: {
          type: Object,
          computed: '_computeRange(shape)'
        },
        /**
         * Computed value of "display name" of the property
         */
        displayName: {
          type: String,
          computed: '_computeDisplayName(range, shape)'
        },
        /**
         * A type property name.
         * This may be different from `displayName` property if
         * `displayName` was specified in the API spec for this property.
         */
        propertyName: {
          type: String,
          computed: '_computePropertyName(range, shape)'
        },
        /**
         * Computed value, true if `displayName` has been defined for this
         * property.
         */
        hasDisplayName: {
          type: Boolean,
          computed: '_computeHasDisplayName(range, shape)'
        },
        /**
         * Computed value, true if current property is an union.
         */
        isUnion: {
          type: Boolean,
          computed: '_computeIsUnion(range)',
          reflectToAttribute: true
        },
        /**
         * Computed value, true if current property is an object.
         */
         isObject: {
          type: Boolean,
          computed: '_computeIsObject(range)',
          reflectToAttribute: true
        },
        /**
         * Computed value, true if current property is an array.
         */
        isArray: {
          type: Boolean,
          computed: '_computeIsArray(range)',
          reflectToAttribute: true
        },
        /**
         * Should be set if described properties has a parent type.
         * This is used when recursively iterating over properties.
         */
        parentTypeName: String,
        /**
         * Computed value of shape data type
         * @type {Object}
         */
        propertyDataType: {
          type: String,
          computed: '_computeType(range, shape)'
        },
        /**
         * Computed value form the shape. True if the property is required.
         */
        isRequired: {
          type: Boolean,
          computed: '_computeIsRequired(shape)'
        },
        /**
         * Computed value form the shape. True if the property is ENUM.
         */
        isEnum: {
          type: Boolean,
          computed: '_computeIsEnum(range)'
        },
        /**
         * A description of the property to render.
         */
        propertyDescription: {
          type: String,
          computed: '_computeDescription(range)'
        }
      };
    }
    _computeType(range, shape) {
      let type = range && this._computeRangeDataType(range);
      if (!type) {
        type = shape  && this._computeRangeDataType(shape);
      }
      return type;
    }
    /**
     * Computes name of the property. This may be different from the
     * `displayName` if `displayName` is set in API spec.
     *
     * @param {Object} range Range object of current shape.
     * @return {String} Display name of the property
     */
    _computePropertyName(range, shape) {
      if (!shape || !range) {
        return;
      }
      if (this._hasType(shape, 'http://raml.org/vocabularies/http#Parameter')) {
        return this._getValue(shape, 'http://schema.org/name');
      }
      return this._getValue(range, 'http://www.w3.org/ns/shacl#name');
    }
    /**
     * Computes value for `hasDisplayName` property.
     * Indicates that `displayName` has been defined in the API specification.
     *
     * @param {Object} range Range object of current shape.
     * @return {Boolean}
     */
    _computeHasDisplayName(range, shape) {
      if (!shape || !range) {
        return false;
      }
      if (this._hasType(shape, 'http://raml.org/vocabularies/http#Parameter')) {
        return !!this._getValue(range, 'http://schema.org/name');
      }
      if (this._hasType(range, 'http://www.w3.org/ns/shacl#NodeShape')) {
        return !!this._getValue(shape, 'http://www.w3.org/ns/shacl#name');
      }
      return !!this._getValue(range, 'http://schema.org/name');
    }
    /**
     * Sets "active" attribute on this element when the border is hovered.
     */
    _borderHover() {
      if (!this.getAttribute('active')) {
        this.setAttribute('active', true);
      }
    }
    /**
     * Removes "active" attribute on this element when the border is not hovered.
     */
    _borderBlur() {
      if (this.getAttribute('active')) {
        this.removeAttribute('active');
      }
    }
    /**
     * Computes value for `isRequired` property.
     * In AMF model a property is required when `http://www.w3.org/ns/shacl#minCount`
     * does not equal `0`.
     *
     * @param {Object} shape Current shape object
     * @return {Boolean}
     */
    _computeIsRequired(shape) {
      if (!shape) {
        return false;
      }
      if (this._hasType(shape, 'http://raml.org/vocabularies/http#Parameter')) {
        return this._getValue(shape, 'http://www.w3.org/ns/hydra/core#required');
      }
      const data = this._getValue(shape, 'http://www.w3.org/ns/shacl#minCount');
      return data !== 0;
    }
    /**
     * Computes value `isEnum` property.
     * @param {Object} range Current `range` object.
     * @return {Boolean} Curently it always returns `false`
     */
    _computeIsEnum(range) {
      return !!(range && ('http://www.w3.org/ns/shacl#in' in range));
    }
    /**
     * Computes value for `propertyDescription`.
     * @param {Object} range Range model
     * @return {String} Description to render.
     */
    _computeDescription(range) {
      if (!range) {
        return;
      }
      return this._getValue(range, 'http://schema.org/description');
    }
  }
  window.customElements.define(PropertyShapeDocument.is, PropertyShapeDocument);
  </script>
</dom-module>
