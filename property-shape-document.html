<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../marked-element/marked-element.html">

<dom-module id="property-shape-document">
  <template>
    <style include="markdown-styles"></style>
    <style>
    :host {
      display: block;
      @apply --property-shape-document;
    }

    [hidden] {
      display: none !important;
    }

    .property-title {
      @apply --arc-font-subhead;
      @apply --property-shape-document-title;
    }

    .property-traits {
      @apply --layout-horizontal;
      @apply --layout-wrap;
    }

    .property-traits > span {
      display: inline-block;
      margin-right: 8px;
      padding: 4px 8px;
      background-color: #EEEEEE;
      border-radius: 3px;
    }

    .property-traits > span.data-type {
      background-color: #2196F3;
      color: white;
    }

    .property-description {
      margin-top: 20px;
    }
    </style>
    <h4 class="property-title">[[displayName]]</h4>
    <div class="property-traits">
      <span class="data-type">[[propertyDataType]]</span>
      <template is="dom-if" if="[[isRequired]]">
        <span class="required-type">Required</span>
      </template>
      <template is="dom-if" if="[[isEnum]]">
        <span class="enym-type">Enum</span>
      </template>
    </div>
    <template is="dom-if" if="[[propertyDescription]]">
      <div class="property-description">
        <marked-element markdown="[[propertyDescription]]">
          <div slot="markdown-html" class="markdown-body"></div>
        </marked-element>
      </div>
    </template>
  </template>
  <script>
  /**
   * `property-shape-document`
   *
   * Renders a documentation for a shape property of AMF model.
   *
   * ## Styling
   *
   * `<property-shape-document>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--property-shape-document` | Mixin applied to this elment | `{}`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   */
  class PropertyShapeDocument extends Polymer.Element {
    static get is() { return 'property-shape-document'; }
    static get properties() {
      return {
        /**
         * A property shape definition of AMF.
         *
         * @type {Object}
         */
        shape: Object,
        /**
         * Computes value of shape's http://raml.org/vocabularies/shapes#range
         * @type {Object}
         */
        shapeRange: {
          type: Object,
          computed: '_computeRange(shape)'
        },
        /**
         * Computed value of "display name" of the property
         */
        displayName: {
          type: String,
          computed: '_computeDisplayName(shape)'
        },
        /**
         * Computed value of shape data type
         * @type {Object}
         */
        propertyDataType: {
          type: String,
          computed: '_computeRangeDataType(shapeRange)'
        },
        /**
         * Computed value form the shape. True if the property is required.
         */
        isRequired: {
          type: Boolean,
          computed: '_computeIsRequired(shape)'
        },
        /**
         * Computed value form the shape. True if the property is ENUM.
         *
         * TODO: This is mocked right now. I am not sure that is the data
         * model for this.
         */
        isEnum: {
          type: Boolean,
          computed: '_computeIsEnum(shapeRange)'
        },
        /**
         * A description of the property to render.
         */
        propertyDescription: {
          type: String,
          computed: '_computeDescription(shapeRange)'
        }
      };
    }
    /**
     * Checks if property item has a type.
     * @param {Object} model Model item.
     * @param {String} type A type to lookup
     * @return {Boolean}
     */
    _hasType(model, type) {
      if (!model) {
        return false;
      }
      const types = model['@type'] || [];
      return types.findIndex((item) => item === type) !== -1;
    }
    /**
     * Gets a signle scalar value from a model.
     * @param {Object} model Amf model to extract the value from.
     * @param {String} key Model key to search for the value
     * @return {any} Value for key
     */
    _getValue(model, key) {
      const data = (model && model[key]);
      if (!data || !(data instanceof Array)) {
        return;
      }
      return data[0]['@value'];
    }
    /**
     * Computes value for `shapeRange` property.
     * @param {Object} shape Current shape object.
     * @return {Object} Range object
     */
    _computeRange(shape) {
      if (!shape) {
        return;
      }
      const data = shape['http://raml.org/vocabularies/shapes#range'];
      return (data && data.length) ? data[0] : undefined;
    }
    /**
     * Computes name label for the shape.
     *
     * @param {Object} shape Current AMF shape
     * @return {String} Display name of the property
     */
    _computeDisplayName(shape) {
      let name = this._getValue(shape, 'http://www.w3.org/ns/shacl#name');
      return name;
    }
    /**
     * Computes value for `propertyDataType`
     * @param {Object} range AMF property range object
     * @return {String} Data type of the property.
     */
    _computeRangeDataType(range) {
      if (!range) {
        return;
      }
      if (this._hasType(range, 'http://raml.org/vocabularies/shapes#UnionShape')) {
        return 'Union';
      }
      if (this._hasType(range, 'http://raml.org/vocabularies/shapes#ArrayShape')) {
        return 'Array';
      }
      if (this._hasType(range, 'http://www.w3.org/ns/shacl#NodeShape')) {
        return 'Object';
      }
      if (this._hasType(range, 'http://raml.org/vocabularies/shapes#ScalarShape')) {
        switch (range['http://www.w3.org/ns/shacl#datatype'][0]['@id']) {
          case 'http://raml.org/vocabularies/shapes#number': return 'Number';
          case 'http://www.w3.org/2001/XMLSchema#integer': return 'Integer';
          case 'http://www.w3.org/2001/XMLSchema#string': return 'String';
          case 'http://www.w3.org/2001/XMLSchema#boolean': return 'Boolean';
          case 'http://www.w3.org/2001/XMLSchema#date': return 'Date';
          case 'http://www.w3.org/2001/XMLSchema#time': return 'Time';
          case 'http://www.w3.org/2001/XMLSchema#dateTime': return 'DateTime';
          case 'http://www.w3.org/2001/XMLSchema#dateTime': return 'Float';
          default: debugger;
        }
      }
      debugger;
    }
    /**
     * Computes value for `isRequired` property.
     * In AMF model a property is required when `http://www.w3.org/ns/shacl#minCount`
     * does not equal `0`.
     *
     * @param {Object} shape Current shape object
     * @return {Boolean}
     */
    _computeIsRequired(shape) {
      const data = this._getValue(shape, 'http://www.w3.org/ns/shacl#minCount');
      return data !== 0;
    }
    /**
     * Computes value `isEnum` property.
     * @param {Object} range Current `range` object.
     * @return {Boolean} Curently it always returns `false`
     */
    _computeIsEnum(range) {
      return !!(range && ('http://www.w3.org/ns/shacl#in' in range));
    }
    /**
     * Computes value for `propertyDescription`.
     * @param {Object} range Range model
     * @return {String} Description to render.
     */
    _computeDescription(range) {
      if (!range) {
        return;
      }
      return this._getValue(range, 'http://schema.org/description');
    }
  }
  window.customElements.define(PropertyShapeDocument.is, PropertyShapeDocument);
  </script>
</dom-module>
