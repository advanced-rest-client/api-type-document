<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../raml-aware/raml-aware.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="property-shape-document.html">
<link rel="import" href="property-document-mixin.html">
<dom-module id="api-type-document">
  <template>
    <style>
    :host {
      display: block;
      @apply --api-type-document;
    }

    paper-button[active] {
      background-color: var(--api-type-document-union-button-background-color, #CDDC39);
    }

    .union-type-selector {
      margin: 20px 0;
    }
    </style>
    <template is="dom-if" if="[[aware]]">
      <raml-aware raml="{{amfModel}}" scope="[[aware]]"></raml-aware>
    </template>
    <template is="dom-if" if="[[isObject]]">
      <template is="dom-repeat" items="[[_computeProperties(type)]]">
        <property-shape-document class="object-document" shape="[[item]]" amf-model="[[amfModel]]" parent-type-name="[[parentTypeName]]"></property-shape-document>
      </template>
    </template>
    <template is="dom-if" if="[[isArray]]">
      <template is="dom-repeat" items="[[_computeArrayProperties(type)]]">
        <property-shape-document class="array-document" shape="[[item]]" amf-model="[[amfModel]]" parent-type-name="[[_computeArrayParentName(parentTypeName, item)]]"></property-shape-document>
      </template>
    </template>
    <template is="dom-if" if="[[isScalar]]">
      <property-shape-document class="shape-document" shape="[[type]]" amf-model="[[amfModel]]" parent-type-name="[[parentTypeName]]"></property-shape-document>
    </template>
    <template is="dom-if" if="[[isUnion]]">
      <div class="union-type-selector">
        <span>Any of:</span>
        <template is="dom-repeat" items="[[unionTypes]]">
          <paper-button class="union-toggle" active="[[_unionTypeActive(selectedUnion, index)]]" on-click="_selectUnion" title$="Select [[item.label]] type">[[item.label]]</paper-button>
        </template>
      </div>
      <api-type-document class="union-document" amf-model="[[amfModel]]" parent-type-name="[[parentTypeName]]" type="[[_computeUnionProperty(type, selectedUnion)]]"></api-type-document>
    </template>
  </template>
  <script>
  /**
   * `api-type-document`
   *
   * An element that recuresively renders a documentation for a data type
   * using from model.
   *
   * Pass AMF's shape type `property` array to render the documentation.
   *
   * ## Styling
   *
   * `<api-type-document>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--api-type-document` | Mixin applied to this elment | `{}`
   *
   * From `property-shape-document`
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--property-shape-document` | Mixin applied each proeprty element | `{}`
   * `--property-shape-document-array-color` | Property border color when type is an array | `#8BC34A`
   * `--property-shape-document-object-color` | Property border color when type is an object | `#FF9800`
   * `--property-shape-document-union-color` | Property border color when type is an union | `#FFEB3B`
   * `--arc-font-subhead` | Theme mixin, applied to the property title | `{}`
   * `--property-shape-document-title` | Mixin applied to the property title | `{}`
   * `--api-type-document-property-parent-color` | Color of the parent property label | `#757575`
   * `--api-type-document-property-color` | Color of the property name label when display name is used | `#757575`
   * `--api-type-document-docs-margin-left` | Margin left of the item's properties description relative to the title. | `12px`
   * `--api-type-document-child-docs-margin-left` | Margin left of the item's properties description relative to the title when the item is a child property of another property | `24px`
   *
   * From `property-range-document`
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--property-range-document` | Mixin applied to this elment | `{}`
   * `--api-type-document-trait-background-color` | Background color to main range trait (type, required, enum) | `#EEEEEE`
   * `--api-type-document-type-background-color` | Background color of the "type" trait | `#2196F3`
   * `--api-type-document-type-attribute-color` | Color of each attribute that describes a property | `#616161`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   * @appliesMixin ArcBehaviors.PropertyDocumentMixin
   */
  class ApiTypeDocument extends ArcBehaviors.PropertyDocumentMixin(Polymer.Element) {
    static get is() { return 'api-type-document'; }
    static get properties() {
      return {
        /**
         * `raml-aware` scope property to use.
         */
        aware: String,
        /**
         * Generated AMF json/ld model form the API spec.
         * The element assumes the object of the first array item to be a
         * type of `"http://raml.org/vocabularies/document#Document`
         * on AMF vocabulary.
         *
         * It is only usefult for the element to resolve references.
         *
         * @type {Object|Array}
         */
        amfModel: Object,
        /**
         * A type definition to render.
         * This should be a one of the following AMF types:
         *
         * - `http://www.w3.org/ns/shacl#NodeShape` (Object)
         * - `http://raml.org/vocabularies/shapes#UnionShape` (Union)
         * - `http://raml.org/vocabularies/shapes#ArrayShape` (Array)
         * - `http://raml.org/vocabularies/shapes#ScalarShape` (single property)
         *
         * It also accepts array of properties like list of headers or
         * parameters.
         * @type {Object|Array}
         */
        type: {
          type: Object,
          observer: '_typeChanged'
        },
        /**
         * Should be set if described properties has a parent type.
         * This is used when recursively iterating over properties.
         */
        parentTypeName: String,
        /**
         * True if given `type` is a scalar property
         */
        isScalar: {
          type: Boolean,
          readOnly: true
        },
        /**
         * True if given `type` is an array property
         */
        isArray: {
          type: Boolean,
          readOnly: true
        },
        /**
         * True if given `type` is an object property
         */
        isObject: {
          type: Boolean,
          readOnly: true
        },
        /**
         * True if given `type` is an union property
         */
        isUnion: {
          type: Boolean,
          readOnly: true
        },
        /**
         * Computed list of union type types to render in union type
         * selector.
         * Each item has `label` and `isScalar` property.
         *
         * @type {Array<Object>}
         */
        unionTypes: {
          type: Array,
          observer: '_unionTypesChanged'
        },
        /**
         * Selected index of union type in `unionTypes` array.
         */
        selectedUnion: {
          type: Number
        }
      };
    }
    /**
     * Checks if property item has a type.
     * @param {Object} record Model item change record.
     * @param {String} type A type to lookup
     * @return {Boolean}
     */
    _hasTypeChangeRecord(record, type) {
      if (!record || !record.base || !record.base) {
        return false;
      }
      const types = record.base['@type'] || [];
      return types.findIndex((item) => item === type) !== -1;
    }
    /**
     * Handles type change. Sets basic view control properties.
     *
     * @param {Array|Object} type Passed type/
     */
    _typeChanged(type) {
      if (!type) {
        return;
      }
      let isScalar = false;
      let isArray = false;
      let isObject = false;
      let isUnion = false;
      if (type instanceof Array) {
        isObject = true;
      } else if (this._hasType(type, 'http://raml.org/vocabularies/shapes#ScalarShape') || this._hasType(type, 'http://raml.org/vocabularies/shapes#NilShape')) {
        isScalar = true;
      } else if (this._hasType(type, 'http://raml.org/vocabularies/shapes#UnionShape')) {
        isUnion = true;
        this.unionTypes = this._computeUnionTypes(true, type);
      } else if (this._hasType(type, 'http://raml.org/vocabularies/shapes#ArrayShape')) {
        isArray = true;
      } else if (this._hasType(type, 'http://www.w3.org/ns/shacl#NodeShape')) {
        isObject = true;
      }
      this._setIsScalar(isScalar);
      this._setIsArray(isArray);
      this._setIsObject(isObject);
      this._setIsUnion(isUnion);
    }
    /**
     * Computes parent name for the array type table.
     *
     * @param {?String} parent `parentTypeName` if available
     * @return {String} Parent type name of refault value for array type.
     */
    _computeArrayParentName(parent) {
      return parent || 'Array';
    }
    /**
     * Resets union selection when union types list changes.
     *
     * @param {?Array} types List of current union types.
     */
    _unionTypesChanged(types) {
      if (!types) {
        return;
      }
      this.selectedUnion = 0;
    }
    /**
     * Handler for union type button click.
     * Sets `selectedUnion` property.
     *
     * @param {ClickEvent} e
     */
    _selectUnion(e) {
      const index = e.model.get('index');
      if (this.selectedUnion === index) {
        e.target.active = true;
      } else {
        this.selectedUnion = index;
      }
    }
    /**
     * Computes if selectedUnion equals current item index.
     *
     * @param {Number} selectedUnion
     * @param {Number} index
     * @return {Boolean}
     */
    _unionTypeActive(selectedUnion, index) {
      return selectedUnion === index;
    }
    /**
     * Computes properties for union type.
     *
     * @param {Object} type Current `type` value.
     * @param {Number} selected Selected union index from `unionTypes` array
     * @return {Array<Object>|undefined} Properties for union type.
     */
    _computeUnionProperty(type, selected) {
      if (!type) {
        return;
      }
      const data = type['http://raml.org/vocabularies/shapes#anyOf'];
      if (!data) {
        return;
      }
      const item = data[selected];
      if (!item) {
        return;
      }
      if (this._hasType(item, 'http://raml.org/vocabularies/shapes#ArrayShape')) {
        const items = item['http://raml.org/vocabularies/shapes#items'];
        if (items && items.length === 1) {
          return items[0];
        }
      }
      return item;
    }
  }
  window.customElements.define(ApiTypeDocument.is, ApiTypeDocument);
  </script>
</dom-module>
